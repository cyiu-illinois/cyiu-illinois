<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="src/style.css" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" integrity="sha512-iBAeBWWWFb8HqSBcrqcz98iIpuVH1la39dEYHtyQ/pGpeCQTQVvLJOWAuhv2Q7JSHp9k7hWA7sGxU3hHJe+tFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Narrative Visualization for CS416</title>
  </head>
  <body onload="init()">
    <div style="display: flex; flex-direction: column; align-items: center;">
    <h2>Trends in COVID-19 death data</h2>
    <p id="text-content" style="text-align:left; width:800px; height:100px">
        The first case of COVID-19 hit Illinois in February 2020 and the first deaths were in March.  
        By May of that year, a first wave had peaked, which we will define for our purposes as a rise followed by a drop 
        in deaths of at least 20% relative to the previous month.    </p>
    <div class="controls">
        <form><button>&lt;</button><button>&gt;</button></form>
    </div>
    <svg width="600" height="300"></svg>
    </div>


    <script>
          async function init() {
            const stateName = "Illinois";

            const parseDate = d3.timeParse("%Y %b");
            const dateFormat = d3.timeFormat("%Y %b");
            var margin = 50, width = 600 - 2 * margin, height = 300 - 2 * margin;
            const data = await d3.csv('https://cyiu-illinois.github.io/data/ILMonthlyP1.csv');

            var xScale = d3.scaleTime()
              .domain([parseDate("2020 Mar"), parseDate("2023 Feb")] )
              .range([ 0, width ]);
            var yScale = d3.scaleLinear().domain([0, 25000]).range([height ,0]);

              d3.select('svg').append('g')
                .attr('transform', 'translate(' + margin + ',' + margin + ')')
                .datum(data)
                .append("path")
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 4)
                .attr("d",
                  d3.line()
                    .x(function (d) {return xScale(parseDate(d.Text_Date))})
                    .y(function (d) {return yScale(d.Deaths_in_Month)})
                )

              d3.select('svg').append('g').attr('transform','translate(' + margin + ',' + margin + ')')
                .call(d3.axisLeft(yScale).tickValues(d3.range(0, 25001, 5000)));
              d3.select('svg').append('g').attr('transform','translate(' + margin + ',' + (height + margin) + ')')
                .call(d3.axisBottom(xScale).ticks(d3.timeMonth.every(12)).tickFormat(d3.timeFormat("%Y-%b")));

              const type = d3.annotationCalloutCircle;

              const annotations = [{
                note: {
                    label: "May 2020: 2994",
                    bgPadding: 2,
                    title: "First Peak"
                },
                x: 78,
                y: 226,
                className: "show-bg",
                dy: -30,
                dx: 0,
                subject: { radius: 10, radiusPadding: 0 },
             }];
      
             const makeAnnotations = d3.annotation()
                .editMode(false)
                .notePadding(2)
                .type(type)
                .annotations(annotations)
      
             d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);

             d3.select("svg").append("text")
                 .attr("x", (width / 2) + margin)
                 .attr("y", (margin / 2))
                 .attr("text-anchor", "middle")
                 .style("font-size", "16px")
                 .style("text-decoration", "underline")
                 .text("COVID-19 Deaths in " + stateName + " per month");


        }


            
    </script>
  </body>
</html>
