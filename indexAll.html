<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="src/style.css" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" integrity="sha512-iBAeBWWWFb8HqSBcrqcz98iIpuVH1la39dEYHtyQ/pGpeCQTQVvLJOWAuhv2Q7JSHp9k7hWA7sGxU3hHJe+tFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Narrative Visualization for CS416</title>
  </head>
  <body onload="init()">
    <div style="display: flex; flex-direction: column; align-items: center;">
      <h2>Trends in COVID-19 death data</h2>
      <p id="text-content" style="text-align:left; width:800px; height:150px">
          The first case of COVID-19 hit Illinois in February 2020 and the first deaths were in March.  
          By May of that year, a first wave had peaked, which we will define for our purposes as a rise followed by a reduction 
          in number of deaths by at least 20% relative to the previous month and a drop of at least 250 in absolute terms.  
          The highest peak across the 3 years of data reported by the New York Times occurred in December of 2020.
          The last peak occurred in January of 2022, after which deaths remained at a fairly constant level without peaking again afterwards.<br />
          While the early peak of Illinois was somewhat similar compared to the others of the six most populous states of the US, the patterns of highest and last peaks vary
          significantly.  Explore to see how each of these states fared.
        </p>
      <div class="controls">
          <a class="button" href="index2.html">&lt;</a> <a class="button disabled">&gt;</a>
      </div>
      <svg width="650" height="300"></svg>
      <div class="controls state-controls">
          <a class="button" id="buttonCA" href="indexAll.html?state=CA">CA</a>
          <a class="button" id="buttonTX" href="indexAll.html?state=TX">TX</a>
          <a class="button" id="buttonFL" href="indexAll.html?state=FL">FL</a>
          <a class="button" id="buttonNY" href="indexAll.html?state=NY">NY</a>
          <a class="button" id="buttonPA" href="indexAll.html?state=PA">PA</a>
          <a class="button" id="buttonIL" href="indexAll.html?state=IL">IL</a>
      </div>
    </div>


    <script>
          function getStateName(abbr) {
            switch (abbr) {
              case "IL":
                return "Illinois";
              case "CA":
                return "California";
              case "TX":
                return "Texas";
              case "NY":
                return "New York";
              case "FL":
                return "Florida";
              case "PA":
                return "Pennsylvania";
              default:
                return "Illinois";
            }
          }

          function updateButtons(abbr) {
            document.getElementById("button" + abbr).className = "button disabled";
          }

          function getDataURL(abbr) {
            return "https://cyiu-illinois.github.io/data/" + abbr + "Monthly.csv";
          }

          function getAnnotationURL(abbr) {
            return "https://cyiu-illinois.github.io/data/" + abbr + "Annotations.json";
          }

          async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            var abbr = urlParams.get('state');
            if (!abbr) abbr = "IL";

            updateButtons(abbr);

            const parseDate = d3.timeParse("%Y %b");
            var data = await d3.csv(getDataURL(abbr));
            data.forEach(function (d) {
              d.dateValue = parseDate(d.Text_Date);
            });


            await fetch(getAnnotationURL(abbr))
              .then(function(response) {
                response.text().then(function(text) {
                  loadGraphAndAnnotations(abbr, data, text);
                });
              });
          }

          function loadGraphAndAnnotations(abbr, data, annotationJSON) {
            const parseDate = d3.timeParse("%Y %b");
            const dateFormat = d3.timeFormat("%b %Y");
            const stateName = getStateName(abbr);

            var margin = 50, width = 650 - 3 * margin , height = 300 - 2 * margin;

            var xScale = d3.scaleTime()
              .domain([parseDate("2020 Mar"), parseDate("2023 Feb")] )
              .range([ 0, width ]);
            var yScale = d3.scaleLinear().domain([0, 25000]).range([height ,0]);

            var svg = d3.select('svg');
            
            svg.append('g')
              .attr('transform', 'translate(' + margin + ',' + margin + ')')
              .datum(data)
              .append("path")
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-width", 4)
              .attr("d",
                d3.line()
                  .x(function (d) {return xScale(d.dateValue)})
                  .y(function (d) {return yScale(d.Deaths_in_Month)})
              );

            svg.append('g').attr('transform','translate(' + margin + ',' + margin + ')')
              .call(d3.axisLeft(yScale).tickValues(d3.range(0, 25001, 5000)));
            svg.append('g').attr('transform','translate(' + margin + ',' + (height + margin) + ')')
              .call(d3.axisBottom(xScale).ticks(d3.timeMonth.every(6)).tickFormat(d3.timeFormat("%Y-%b")));

            const type = d3.annotationCalloutCircle;
            const annotations = eval(annotationJSON);
            const makeAnnotations = d3.annotation()
              .editMode(false)
              .notePadding(2)
              .type(type)
              .annotations(annotations)
      
            svg.append("g")
              .attr("class", "annotation-group")
              .call(makeAnnotations);

            svg.append("text")
              .attr("x", (width / 2) + 1.5 * margin)
              .attr("y", (margin / 2))
              .attr("text-anchor", "middle")
              .style("font-size", "16px")
              .style("text-decoration", "underline")
              .text("COVID-19 Deaths in " + stateName + " per month");

            var tooltipG = svg.append("g").attr('transform', 'translate(' + margin + ',' + margin + ')');
            var focus = tooltipG.append("g").style("display", "none");


            // append the x line
            focus.append("line")
                .attr("class", "x")
                .style("stroke", "blue")
                .style("stroke-dasharray", "3,3")
                .style("opacity", 0.5)
                .attr("y1", 0)
                .attr("y2", height);

            // append the y line
            focus.append("line")
                .attr("class", "y")
                .style("stroke", "blue")
                .style("stroke-dasharray", "3,3")
                .style("opacity", 0.5)
                .attr("x1", width)
                .attr("x2", width);

            focus.append("circle")
                .attr("class", "y")
                .style("fill", "none")
                .style("stroke", "blue")
                .attr("r", 2);


            focus.append("text")
              .attr("class", "y1")
              .style("stroke", "white")
              .style("stroke-width", "3.5px")
              .style("opacity", 0.8)
              .attr("dx", 8)
              .attr("dy", "-.3em");
    
            focus.append("text")
              .attr("class", "y2")
              .attr("dx", 8)
              .attr("dy", "-.3em");

            focus.append("text")
              .attr("class", "y3")
              .style("stroke", "white")
              .style("stroke-width", "3.5px")
              .style("opacity", 0.8)
              .attr("dx", 8)
              .attr("dy", "1em");
            
            focus.append("text")
              .attr("class", "y4")
              .attr("dx", 8)
              .attr("dy", "1em");
    
            tooltipG.append("rect")
              .attr("width", width)
              .attr("height", height)
              .style("fill", "none")
              .style("pointer-events", "all")
              .on("mouseover", function() { focus.style("display", null); })
              .on("mouseout", function() { focus.style("display", "none"); })
              .on("mousemove", mousemove);

            var bisectDate = d3.bisector(function(d) { return d.dateValue; }).left;


            function mousemove() {
              var x0 = xScale.invert(d3.mouse(this)[0]),
                  i = bisectDate(data, x0, 1),
                  d0 = data[i - 1],
                  d1 = data[i],
                  d = d1 && (x0 - d0.dateValue > d1.dateValue - x0) ? d1 : d0;

              focus.select("circle.y")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")");
              
              focus.select("text.y1")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")")
                .text(dateFormat(d.dateValue));

              focus.select("text.y2")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")")
                .text(dateFormat(d.dateValue));

              focus.select("text.y3")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")")
                .text(d.Deaths_in_Month);

              focus.select("text.y4")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")")
                .text(d.Deaths_in_Month);

		          focus.select(".x")
                .attr("transform",
                      "translate(" + xScale(d.dateValue) + "," + yScale(d.Deaths_in_Month) + ")")
                .attr("y2", height - yScale(d.Deaths_in_Month));

		          focus.select(".y")
                .attr("transform",
                      "translate(" + width * -1 + "," +
		                                 yScale(d.Deaths_in_Month) + ")")
                .attr("x2", width + width);




            }                                         

        }


            
    </script>
  </body>
</html>
